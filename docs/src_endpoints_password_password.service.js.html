<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: src/endpoints/password/password.service.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: src/endpoints/password/password.service.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** 
 * Password Routes
 * @namespace endpoints/password/service
 * 
 * @requires ../../app-packages/models/response.model
 * @requires ./password.refresh.repository
 * @requires ./password.user.repository
 */
const Response = require('../../app-packages/models/response.model')
const dbRefreshRepository = require('./password.refresh.repository')
const dbUserRepository = require('./password.user.repository')
const passwordManager = require('../../app-packages/password.manager')
const tokenGeneratorUtility = require('../../app-packages/token/jwt.token.generator')
const logger = require('../../app-packages/logger')
const passwordConfig = require('./password.config')
const objectValidator = require('../../app-packages/object.validator');
const initialPasswordChangeRequestShema = require('./shemas/initialPasswordChange.request.shema')

const tokentOptions = require('../../app-packages/token/jwt.token.options').signOptions;
const refreshTokenOptions = require('../../app-packages/token/jwt.token.options').verifyRefreshOptions;

ObjectId = require('mongodb').ObjectId;

/**
 * Changes initial password on not confirmed logins
 * @memberof endpoints/password/service
 * @param {Express.req} req Endpoind Request
 */
async function initialPasswordChange(req) {
    try {
        const requestValidation = objectValidator(req, initialPasswordChangeRequestShema);
        if (!requestValidation.success) {
            logger.error(`Invalid User Request: ${requestValidation.message}`)
            return Response.createResponse(false, "Invalid User Credentials", 404);
        }

        const email = req.email;
        const oldPassword = req.oldPassword;
        const newPassword = req.newPassword;

        const users = await dbUserRepository.findUser(email.trim());

        if (!users || users.length == 0) {
            logger.warn(`User with email: ${email}, is not found`);
            return Response.createResponse(false, "Invalid User Credentials", 404);
        }

        if (users.length > 1) {
            logger.error("WARNING! FOUND MORE THE ONE UNIQUE USERS")

            return Response.createResponse(false, "Invalid User Credentials", 404);
        }

        const user = users[0];

        // User is Locked
        if (user.isLocked) {
            logger.error(`User: ${user._id} : Is Locked and try to login`)

            return Response.createResponse(false, "Invalid User Credentials", 404);
        }

        const cmp = await passwordManager.verify(oldPassword, user.password);
        if (cmp) {

            if (!user.passwordConfirmed) {
                logger.info(`User: ${user._id} : Is Performing first log in password change`)

                // change password and passwordConfirmed
                const hashedPwd = await passwordManager.encrypt(newPassword, passwordConfig.SALT_ROUND);

                if (hashedPwd === user.password) {
                    logger.error(`User: ${user._id} : Is Trying same password as new`)

                    return Response.createResponse(false, "Invalid User Credentials", 404);
                }

                await dbUserRepository.updatePasswordConfirmation(user._id, true, hashedPwd);

                const signToken = tokenGeneratorUtility.generate({ userId: user._id }, tokentOptions);
                const refreshToken = tokenGeneratorUtility.generate({ userId: user._id }, refreshTokenOptions);

                let newRefreshToken = await dbRefreshRepository.add(refreshToken.token);

                return Response.createResponse(true, "User Logged In Succesfully", 200, {
                    idToken: signToken.token,
                    refreshToken: newRefreshToken
                });

            } else {
                logger.error(`User: ${user._id} : TRUING TO CHANGE PASSWORD AGAIN!!!`)

                return Response.createResponse(false, "Invalid User Credentials", 404);
            }
        } else {
            return Response.createResponse(false, "Invalid User Credentials", 404);
        }
    } catch (error) {
        logger.error(`ERROR: ${error}`)

        return Response.createResponse(false, "Invalid Request" , 404);
    }

}

/**
 * Password Configuration
 * @module auth
 */
module.exports = { initialPasswordChange };</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-app-packages_http-client.html">app-packages/http-client</a></li><li><a href="module-app-packages_logger.html">app-packages/logger</a></li><li><a href="module-app-packages_middlewares.html">app-packages/middlewares</a></li><li><a href="module-app-packages_models.html">app-packages/models</a></li><li><a href="module-app-packages_object-validator.html">app-packages/object-validator</a></li><li><a href="module-auth.html">auth</a></li><li><a href="module-db.html">db</a></li><li><a href="module-refresh.html">refresh</a></li></ul><h3>Namespaces</h3><ul><li><a href="app-package_http-client.html">app-package/http-client</a></li><li><a href="app-package_object-validator.html">app-package/object-validator</a></li><li><a href="app-package_password-manager.html">app-package/password-manager</a></li><li><a href="app-package_token_jwt-auth-middleware.html">app-package/token/jwt-auth-middleware</a></li><li><a href="app-package_token_jwt-token-generator.html">app-package/token/jwt-token-generator</a></li><li><a href="app-package_token_jwt-token-options.html">app-package/token/jwt-token-options</a></li><li><a href="app-packages_db_data-mongodb.html">app-packages/db/data-mongodb</a></li><li><a href="app-packages_db_seed.html">app-packages/db/seed</a></li><li><a href="app-packages_logger.html">app-packages/logger</a></li><li><a href="app-packages_middlewares.html">app-packages/middlewares</a></li><li><a href="app-packages_models.html">app-packages/models</a></li><li><a href="app_app.html">app/app</a></li><li><a href="app_middleware.html">app/middleware</a></li><li><a href="app_routes.html">app/routes</a></li><li><a href="app_security.html">app/security</a></li><li><a href="app_server.html">app/server</a></li><li><a href="app_setup.html">app/setup</a></li><li><a href="endpoints_auth_controller.html">endpoints/auth/controller</a></li><li><a href="endpoints_auth_refresh-repository.html">endpoints/auth/refresh-repository</a></li><li><a href="endpoints_auth_routes.html">endpoints/auth/routes</a></li><li><a href="endpoints_auth_services.html">endpoints/auth/services</a></li><li><a href="endpoints_auth_shemas_auth-request.html">endpoints/auth/shemas/auth-request</a></li><li><a href="endpoints_auth_user-repository.html">endpoints/auth/user-repository</a></li><li><a href="endpoints_password_controller.html">endpoints/password/controller</a></li><li><a href="endpoints_password_refresh-repository.html">endpoints/password/refresh-repository</a></li><li><a href="endpoints_password_routes.html">endpoints/password/routes</a></li><li><a href="endpoints_password_service.html">endpoints/password/service</a></li><li><a href="endpoints_password_shemas_initialPasswrdChange-request.html">endpoints/password/shemas/initialPasswrdChange-request</a></li><li><a href="endpoints_password_user-repository.html">endpoints/password/user-repository</a></li><li><a href="endpoints_refresh_controller.html">endpoints/refresh/controller</a></li><li><a href="endpoints_refresh_repository.html">endpoints/refresh/repository</a></li><li><a href="endpoints_refresh_routes.html">endpoints/refresh/routes</a></li><li><a href="endpoints_refresh_service.html">endpoints/refresh/service</a></li><li><a href="endpoints_refresh_user-repository.html">endpoints/refresh/user-repository</a></li><li><a href="env.html">env</a></li></ul><h3>Global</h3><ul><li><a href="global.html#MongoClient">MongoClient</a></li><li><a href="global.html#_db">_db</a></li><li><a href="global.html#appConfigMod">appConfigMod</a></li><li><a href="global.html#appConfigs">appConfigs</a></li><li><a href="global.html#appMiddlewares">appMiddlewares</a></li><li><a href="global.html#appSecurityHeaders">appSecurityHeaders</a></li><li><a href="global.html#appServer">appServer</a></li><li><a href="global.html#appSetupFunctions">appSetupFunctions</a></li><li><a href="global.html#authConfigMod">authConfigMod</a></li><li><a href="global.html#bcrypt">bcrypt</a></li><li><a href="global.html#createResponse">createResponse</a></li><li><a href="global.html#database">database</a></li><li><a href="global.html#dbConfigMod">dbConfigMod</a></li><li><a href="global.html#dbContext">dbContext</a></li><li><a href="global.html#destroyByIds">destroyByIds</a></li><li><a href="global.html#encrypt">encrypt</a></li><li><a href="global.html#envConfigs">envConfigs</a></li><li><a href="global.html#fs">fs</a></li><li><a href="global.html#logger">logger</a></li><li><a href="global.html#passwordManager">passwordManager</a></li><li><a href="global.html#path">path</a></li><li><a href="global.html#refreshRequestShema">refreshRequestShema</a></li><li><a href="global.html#responseModel">responseModel</a></li><li><a href="global.html#signOptions">signOptions</a></li><li><a href="global.html#url">url</a></li><li><a href="global.html#verify">verify</a></li><li><a href="global.html#verifyOptions">verifyOptions</a></li><li><a href="global.html#verifyRefreshOptions">verifyRefreshOptions</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Sun Jul 16 2023 10:00:16 GMT+0300 (Eastern European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
